# Project Spec: Pangolog

## Overview

A minimalist personal expense tracker progressive web app with a focus on simplicity, cross-device persistence, and data ownership.

## Tech Stack
- Frontend: NextJS, Tailwind, IndexedDB, Biome for linting
- State management: Zustand, TanStack Query
- Backend: Google Drive for cloud sync
- Deployment: Vercel

Approach:
    - TanStack Query as the source of truth for UI
    - IndexedDB as the local cache/persistence layer
    - Google Drive as the remote backup

## Business logic terms:
- Big buck: large and irregular transactions attached to a year.
- Small dime: small daily transactions attached to a month.

## Features

### Transaction management
- Read: query small dime transactions by month
- Read: query big buck transactions by month
- Read: search by text description among currently displayed transactions
- Create: create new transactions with the following setting options
    - Transaction amount
    - Expense or income
    - Small dime or big buck
    - One single category to attach the transaction to
- Create: recurring transaction on a weekly or monthly basis
- Update: edit existing transactions
- Delete: permanently remove existing transactions

### Category management
- Read: view current categories
- Create: add new categories
    - Name
    - Colour
    - Emoji icon
- Update: reorder category priority in the create transaction dialog
- Delete: remove transaction

### Advanced financial review:
- View segmented bar summary by month, with and without big buck transactions
- View segmented bar summary by year, with and without big buck transactions

### Synchronisation
- Cloud synchronisation is entirely optional, users can start using immediately without providing Google Drive authorisation.
- New users are seeded with demo data (categories: Food, Grocery, Videogame; transactions: Eggs, Sandwich, What Remains of Edith Finch).
- On first sync, users are prompted whether to carry over seed data to the cloud or discard it before syncing.
- Data is sync'ed with transaction, debounced to 30s.
- Data is sync'ed upon `visibilitychange` and `document.visibilityState === hidden`.
- Data is resolved on the "Last write wins", using `updatedAt`.
- Transactions are not hard-deleted. Use `deletedAt`.
- Deleted transactions remain stored to facilitate deletion propagation.
- Data with `deletedAt` older than 30 days are removed on both local and cloud instance.

### Error recovery strategies
- Exponential backoff (30s, 60s, 120s, 300s)
- Max retry attempts: 5
- Failed operations stored in sync queue
- Manual retry option in UI

### Data mobility
- Export transactions to JSON, xls or csv
- Import transactions from local JSON, xls or csv
- Data import should be able to also add categories

### Other settings
- Freely user-set custom currency (as a string), as a prefix or suffix. E.g. `$12` or `12k IDR`. This is merely a cosmetic display unit, and has no bearing on the logic and/or data.

### Offline support
- Works offline without an internet connection
- Offline indicator
- Queue changes made offline for sync when connection returns

## Data model

### Table `dimes`
- `id`: uuid, autogenerated primary key.
- `transactedAt`: iso timestamp, datetime of transaction.
- `updatedAt`: iso timestamp, date of updating (also for collision resolution logic).
- `deletedAt`: iso timestamp, date of deletion for soft deletion and sync'ing purpose. `null` by default.
- `categoryId`: uuid, foreign key to `categories`.
- `amount`: integer (Stored as minor units, e.g., 100 for $1.00 or 100 for 100 VND).
    - Must be > 0
- `year`: integer, derived field from `transactedAt`
- `month`: integer, derived field from `transactedAt`
- `description`: string, user description for the transaction.
- `isIncome`: boolean, whether the transaction is a positive income instead of expense.
- indexes:
    - [year, month] for month queries
    - categoryId for joins
    - transactedAt for sorting

### Table `bucks`
- `id`: uuid, autogenerated primary key.
- `transactedAt`: iso timestamp, datetime of transaction.
- `updatedAt`: iso timestamp, date of updating (also for collision resolution logic).
- `deletedAt`: iso timestamp, date of deletion for soft deletion and sync'ing purpose. `null` by default.
- `categoryId`: uuid, foreign key to `categories`.
- `amount`: integer (Stored as minor units, e.g., 100 for $1.00 or 100 for 100 VND).
- `year`: integer, derived field from `transactedAt`
- `description`: string, user description for the transaction.
- `isIncome`: boolean, whether the transaction is a positive income instead of expense.
- indexes:
    - year queries
    - categoryId for joins
    - transactedAt for sorting

### Table `categories`
- `id`: uuid, autogenerated primary key.
- `createdAt`: iso timestamp, datetime of creation.
- `updatedAt`: iso timestamp, date of updating (also for collision resolution logic).
- `colour`: string, colour hex code.
- `icon`: string, the single emoji icon for the category.
- `priority`: number, custom sort order value.
- `isBuckOnly`: boolean, this will only be displayed when adding Big Buck expenses.
- `isIncomeOnly`: boolean, this will only be displayed when adding income transactions.
    A category can be both `isBuckOnly` and `isIncomeOnly` and these are not mutually exclusive.

### Table `recurring-rules`
- `id`: uuid, primary key
- `createdAt`: iso timestamp
- `updatedAt`: iso timestamp
- `deletedAt`: iso timestamp
- `categoryId`: uuid, foreign key to categories
- `amount`: integer (minor units)
- `description`: string
- `isIncome`: boolean
- `isBigBuck`: boolean
- `frequency`: 'daily' | 'weekly' | 'monthly' | 'yearly'
- `dayOfWeek`: integer (0-6, for weekly)
- `dayOfMonth`: integer (1-31, for monthly)
- `monthOfYear`: integer (1-12, for yearly)
- `lastGeneratedAt`: iso timestamp
- `nextGenerationAt`: iso timestamp
- `isActive`: boolean

## LocalStorage global state data
- `isDarkTheme`: boolean
- `isSyncEnabled`: boolean
- `lastSyncTime`: iso string
- `syncError`: string
- ~~`hasUsedBefore`: boolean,~~ no longer used
- `isViewingBigBucks`: boolean
- `shouldIncludeBucksInDimes`: boolean
- `lastSelectedMonth`: string, e.g. `"2026-02"`

## LocalStorage settings to be synced
- `customCurrency`: string, custom currency set by user, empty by default.
- `isPrefixCurrency`: boolean, whether to display the currency in front of the amount, to differentiate different conventions. E.g. $12 and 12 SGD.
- `settingsUpdatedAt`: ISO timestamp, used for last-write-wins conflict resolution when syncing settings to Drive and JSON export/import.

## Storage approach
- OAuth scope: `drive.file` + `drive.readonly` - `drive.readonly` enables cross-device file discovery (listing all files in the Pangolog folder); `drive.file` handles creating and updating files. Files remain visible in the user's Google Drive.
- Files are stored in a dedicated `Pangolog` folder in the user's Drive root.
- Settings are stored in `settings.json`.
- Categories are stored in `categories.json`.
- RecurringRules are stored in `recurring-rules.json`.
- Small dime transactions are stored on a monthly basis, e.g. `2026-02.json`.
- Big bucks are stored separately on a yearly basis, e.g. `2026-bucks.json`.

## Design system
- User-switchable dark/light theme
- UI library: HeroUI
- Vibe: minimalist, clear, and readable. Heavy usage of monospace fonts.
- Loading states for async operations.
- Skeleton screens for initial loads.
- Toast notifications (sonner) for: deletion with undo action, Google Drive connection, successful manual sync, and sync errors.

### Layout
(Excluding Landing Page)
- Main view
- Navbar to switch between routes
- Floating CTA button `Add transaction` (or `Add category` in the category route)
- Sync status indicator
    - Grey: not configured
    - Green: synced
    - Blue: sync in progress
    - Red: encountering error, with message

### Navbar
- A list of to the app's routes (e.g. `/log`, `/settings`)
    - Position: on top of main view, similar to tab list/tab switch
    - Has icon and label
    - Current route is indicated
    - Mobile layout: floating at the bottom of the viewport

### Utility panel
- Position: to the right of the header
    - Sync indicator
    - Theme switcher

### Views

- Transaction view:
    - List of transactions according to current settings in descending order (lower is older)
    - Toggle switch: Small Dimes vs Big Bucks
    - Checkbox: (Small Dimes only) Also show Big Buck transactions
    - Calendar month picker: (Small Dimes only) Month to display Small Dimes transactions
    - Dropdown: Filter transactions by category. Includes "Uncategorised" option, Check all / Uncheck all utility buttons. Active filter indicated on trigger button.
    - Empty state: there is no transaction for this month/year
    - Item without category is marked `uncategorised`

- Magic input in transaction view, ignore this unless specified:
    - A magic input with multiple function
    - Primary function: search by description
    - Alternative function: add new transaction via specified syntax
        - `t: <amount> <category priority index> <-b> <-i>`
            - Flag: `-b` for big buck
            - Flag: `-i` for income
        - e.g. `t: 12 2` adds a new Small Dime expense transaction of $12, with the category with priority index 2.
        - e.g. `t: 500 -i -b` adds a new Big Buck income transaction of $500, with no category.
    - Quick focus with Ctrl/Cmd + F

- Dialog: add new transaction/edit transaction (shared by both Small Dimes and Big Bucks)
    - Toggle switch: income vs expense.
    - Toggle switch: Small Dimes vs Big Bucks (not available when editing).
    - Date of transaction: current date by default
    - Category accordion:
        - Collapsed: 7 categories of highest priority.
        - Expended: show all categories in a half-screen scrollable area.
        - Selecting a Category is performed by clicking on a Category that is not yet selected.
        - Deselecting a Category is performed by clicking on the selected Category.
    - Input is capped to two decimal points.
    - Future consideration: setting for auto-adding decimal point.

- Summary view
    - Toggle switch: monthly vs yearly.
    - Toggle switch: Small Dimes vs Big Bucks (yearly only).
    - Checkbox: include Big Buck transactions alongside dimes (yearly, Small Dimes mode only).
    - Data: Segmented horizontal bar for expenses and incomes, each with a legend (category icon, name, amount, %). Categories below 3% are collapsed into "Other".

- Landing page
    - Overview description of the app.
    - Default page if user is just a visitor.
    - Approach for implementation:
        - Check existing IndexedDB data.
        - ~~Set flag on first meaningful action (e.g. adding first transaction or category?) `hasUsedBefore` (invisible to user).~~ User will now have free access to all routes without any intentional redirection. PWA manifest will point to the main route as the default starting url.
        - Implement a root page and return accordingly.

- Category management view
    - Drag and drop list of categories
    - Item comes with edit button
    - Priority index (array index + 1) should be clearly visible
    - Empty state: There is no category created yet

- Dialog: add/edit category
    - Name
    - Colour hex code (colour picker included)
    - Emoji-based icon
    - Checkbox: is income-only category
    - Checkbox: is big buck-only category

- Recurring transactions view
    - Overview of list of recurring transaction rules
        - Category, description, amount, frequency
        - Switch to turn the on/off
    - Sorting option:
        - `createdAt`
        - `amount`
        - `nextGeneratedAt`
        - `frequency`

- Dialog: add/edit recurring transactions
    - Regular settings for transactions
    - Settings specific for recurring transactions

- Settings view
    - Custom display currency unit
    - Configuring Drive sync

## Recurring expenses
- Frequency choices: daily, weekly, monthly, yearly
- `nextGenerationdAt` is calculated upon changes in:
    - `frequency`
    - `dayOfWeek`
    - `dayOfMonth`
    - `dayOfYear`
- Execution logic:
    - Upon startup, `visibilitychange` (similar to sync)
    - Query items with `nextGeneratedAt` older than current time
    - Iterate over matching rule, loop this:
        - Create the transaction
        - Advance `nextGenerationAt` until `nextGenerationAt` is in the future
        - IMPORTANT: create only one new row per execution
            - Implication: For users who do not use the app frequently, gap in history is silently lost.
            - User should be warned of this implication somewhere.

### Monthly/yearly day clamping
For monthly and yearly rules, if `dayOfMonth` exceeds the number of days in the target month (e.g. the 31st in April, or the 29th in a non-leap February), the date is clamped to the last day of that month. This is computed as `Math.min(dayOfMonth, lastDayOfMonth)`.

## Technical Decisions

### Danger Zone reset action
The settings page includes a "Danger Zone" section with a "Reset all data" button. On confirmation, it disconnects Google Drive, clears all local IndexedDB stores, shows a success toast, and reloads the page after 1.5 seconds. The page reload is necessary to ensure a clean module state - without it, a stale `dbPromise` can cause all subsequent DB operations to fail.

`clearAllData()` first attempts a standard store-clear transaction. If `getDb()` fails (e.g. the stored DB is at a higher version than the code requests - a `VersionError`), it falls back to `forceDeleteDb()` which bypasses the version check and deletes the entire database. This handles cases where a user has a cached PWA build at a different schema version.

### Keyboard flash on Android when closing dialog via backdrop tap
On Android (Chrome and Firefox), tapping the backdrop to dismiss a dialog causes the virtual keyboard to flash briefly before disappearing. This happens because the input blur fires mid-close-animation, after the dismiss has already begun. The fix: `handleBackdropTouchStart` on the Modal detects a touch outside `[role="dialog"]` (i.e. the backdrop) and calls `blur()` on `touchstart`. Since `touchstart` precedes the `click` that triggers `onClose`, the keyboard has a full touch event cycle to dismiss before the modal begins closing.

### Known issue: dialog input scroll on Firefox Android
On Firefox Android, focusing an input inside a dialog scrolls it out of view above the fixed bottom navbar. A potential fix: disable `autoFocus` on touch devices via a `useIsPointerFine` hook that checks the `(pointer: fine)` media query. Not applied - the issue is intermittent and unconfirmed on other mobile browsers.

### UUID generation fallback for non-secure contexts
`crypto.randomUUID()` requires a secure context (HTTPS). `localhost` qualifies, but accessing the app over HTTP via a local network IP (e.g. during development from a phone) does not. All record creation would fail silently in this case. A `generateId()` utility in `src/lib/db/uuid.ts` wraps `crypto.randomUUID()` with a `Math.random()`-based UUID v4 fallback for non-secure contexts. All DB create functions use this instead of calling `crypto.randomUUID()` directly.

### Service worker considerations for offline support
The PWA manifest is in place but no service worker is configured yet. Implementing one to cache the app shell involves the following considerations:

1. **Stale app shell after deployment** — Users may keep running an old cached version after a new deployment until the browser's SW update cycle fires. Workbox handles this with a versioned precache manifest.
2. **Development interference** — Service workers must be disabled in dev to avoid breaking Next.js hot reload, meaning offline behaviour can only be tested in a production build.
3. **DB version mismatch** — An aggressively cached app shell can persist old schema versions longer, worsening the `VersionError` problem. The existing `forceDeleteDb()` fallback handles this.
4. **OAuth popup compatibility** — The Google OAuth flow opens a popup to a different origin so the SW won't intercept it, but the callback page and `postMessage` flow should be smoke-tested after setup.
5. **Next.js App Router compatibility** — `next-pwa` is largely unmaintained; the App Router-compatible fork is `@ducanh2912/next-pwa`. Alternatively, a hand-written `sw.js` with a `cache.addAll()` on install and a cache-first fetch strategy is viable for a solo project — the only maintenance cost is bumping a cache version constant on each deployment. Pin Next.js and the SW plugin versions and upgrade them together.

A manual "Clear service worker cache" button in Settings (debug section) is a useful escape hatch during development and testing.

### Separation of Big Bucks and Small Dimes storage (vs `isBigBuck`)
- Query patterns are separated
- Storage strategy matches query patterns
- Indexes are simpler and more efficient
- Reduce metadata requires for Google Drive files
